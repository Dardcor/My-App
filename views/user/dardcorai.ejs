<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <link rel="manifest" href="/manifest.json">
    
    <title>Dardcor AI</title>
    <link rel="icon" href="/logo.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* ... (Style sama seperti sebelumnya, hanya perbaikan Sidebar di bawah) ... */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #1a1a2e;
            color: #cbd5e1;
            overflow: hidden; /* Penting untuk layout chat */
            height: 100vh;
        }
        
        /* Sidebar Transition */
        #sidebar {
            transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;
            z-index: 50;
        }
        
        /* Sidebar State Classes */
        .sidebar-open-desktop { width: 280px; transform: translateX(0); }
        .sidebar-closed-desktop { width: 0; transform: translateX(0); overflow: hidden; }
        
        .sidebar-open-mobile { transform: translateX(0); }
        .sidebar-closed-mobile { transform: translateX(-100%); }

        /* Overlay for mobile */
        #overlay {
            transition: opacity 0.3s ease-in-out;
            z-index: 40;
        }
        
        /* Main Content Adjustment */
        #mainContent {
            transition: margin-left 0.3s ease-in-out;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Chat Bubbles */
        .message-user {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border-radius: 18px 18px 4px 18px;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        }
        .message-bot {
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 18px 18px 18px 4px;
            border: 1px solid #334155;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* Code Blocks */
        .code-block-wrapper { margin: 12px 0; border-radius: 8px; overflow: hidden; background: #0d1117; border: 1px solid #30363d; }
        .code-header { display: flex; justify-content: space-between; align-items: center; background: #161b22; padding: 8px 12px; border-bottom: 1px solid #30363d; font-size: 0.75rem; color: #7d8590; }
        pre { margin: 0 !important; padding: 0 !important; background: transparent !important; }
        code.hljs { padding: 16px !important; font-family: 'Fira Code', monospace; font-size: 0.85rem; line-height: 1.5; background: #0d1117 !important; }
        
        /* Chat Input */
        .chat-input { background: #1e293b; border: 1px solid #334155; border-radius: 1.5rem; transition: all 0.2s; }
        .chat-input:focus-within { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }

        /* Typing Indicator */
        .typing-indicator span {
            display: inline-block; width: 6px; height: 6px; background-color: #94a3b8; border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both; margin: 0 1px;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* Markdown */
        .markdown-body { line-height: 1.6; }
        .markdown-body p { margin-bottom: 0.75rem; }
        .markdown-body ul, .markdown-body ol { padding-left: 1.5rem; margin-bottom: 0.75rem; }
        .markdown-body li { margin-bottom: 0.25rem; }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { margin-top: 1rem; margin-bottom: 0.5rem; font-weight: 600; }
    </style>
</head>

<body class="flex h-screen overflow-hidden bg-[#1a1a2e]">

    <div id="overlay" class="fixed inset-0 bg-black/50 hidden lg:hidden" onclick="toggleSidebar()"></div>

    <aside id="sidebar" class="flex flex-col h-full fixed lg:relative w-64 lg:w-72 bg-[#131b2e] border-r border-gray-800 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out">
        
        <div class="p-4 flex items-center justify-between border-b border-gray-800 bg-[#131b2e]">
            <a href="/user/home" class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-purple-600 rounded-xl flex items-center justify-center text-white shadow-lg">
                    <i class="fas fa-robot text-lg"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-white">Dardcor AI</h1>
                    <p class="text-xs text-gray-400">Asisten Cerdas</p>
                </div>
            </a>
            <button onclick="toggleSidebar()" class="lg:hidden text-gray-400 hover:text-white p-2 rounded-lg hover:bg-gray-800">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <div class="p-4">
            <button id="newChatBtn" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white py-3 px-4 rounded-xl flex items-center justify-center gap-2 shadow-lg shadow-blue-900/30 font-medium transition-all duration-200 active:scale-95">
                <i class="fas fa-plus"></i>
                <span>Chat Baru</span>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto px-3 custom-scrollbar">
            <div class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider sticky top-0 bg-[#131b2e] z-10 mb-2">
                Riwayat Percakapan
            </div>
            
            <div class="space-y-1 pb-4">
                <% if (typeof fullHistory !== 'undefined' && fullHistory.length > 0) { 
                    const reversedHistory = fullHistory.slice().reverse();
                    for(let i = 0; i < reversedHistory.length; i++) {
                        const conv = reversedHistory[i];
                        const isActive = conv.conversation_id === activeConversationId;
                        const title = (conv.message || 'Percakapan Baru').substring(0, 30) + (conv.message?.length > 30 ? '...' : '');
                %>
                    <a href="/user/dardcor-ai/<%= conv.conversation_id %>" 
                       class="flex items-center gap-3 px-3 py-3 rounded-lg text-sm transition-all duration-200 <%= isActive ? 'bg-gradient-to-r from-blue-900/30 to-blue-800/20 text-white border-l-4 border-blue-500' : 'text-gray-400 hover:bg-gray-800/50 hover:text-gray-200' %>">
                        <i class="fas fa-comment text-xs <%= isActive ? 'text-blue-400' : 'text-gray-600' %>"></i>
                        <span class="truncate flex-1"><%= title %></span>
                        <span class="text-xs text-gray-600"><%= new Date(conv.timestamp || Date.now()).toLocaleDateString('id-ID', {month: 'short', day: 'numeric'}) %></span>
                    </a>
                <% }} else { %>
                    <div class="text-center py-10 px-4 opacity-50">
                        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gray-800 flex items-center justify-center">
                            <i class="fas fa-comment-slash text-2xl text-gray-600"></i>
                        </div>
                        <p class="text-gray-600 text-sm">Belum ada percakapan</p>
                    </div>
                <% } %>
            </div>
        </div>

        <div class="p-4 border-t border-gray-800 bg-[#131b2e]">
            <a href="/user/profile" class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-800 transition-all duration-200">
                <div class="relative">
                    <img src="<%= user.profile_image || 'https://ui-avatars.com/api/?name=' + (user.username || 'User') + '&background=random&color=fff' %>" 
                         class="w-10 h-10 rounded-full object-cover border-2 border-gray-700">
                    <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-[#131b2e]"></div>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-white truncate"><%= user.full_name || user.username %></p>
                    <p class="text-xs text-gray-500 truncate">@<%= user.username %></p>
                </div>
            </a>
        </div>
    </aside>

    <main id="mainContent" class="flex-1 flex flex-col h-full w-full bg-[#1a1a2e] transition-all duration-300 relative">
        
        <header class="h-16 flex items-center justify-between px-4 md:px-6 border-b border-gray-800 bg-[#1a1a2e] sticky top-0 z-40 shadow-sm">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="p-2 rounded-lg text-gray-400 hover:text-white hover:bg-gray-800 transition-all duration-200">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600/20 to-purple-600/20 flex items-center justify-center border border-white/5 hidden sm:flex">
                        <i class="fas fa-robot text-blue-400"></i>
                    </div>
                    <div>
                        <h2 class="font-semibold text-white text-sm md:text-base">Asisten Dardcor AI</h2>
                        <p class="text-xs text-green-400 flex items-center gap-1">
                            <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span> 
                            Online
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <button onclick="toggleFullscreen()" class="p-2 text-gray-400 hover:text-white rounded-lg hover:bg-gray-800 transition-all duration-200 hidden sm:block" title="Fullscreen">
                    <i id="fullscreenIcon" class="fas fa-expand"></i>
                </button>
                <button onclick="clearChat()" class="p-2 text-gray-400 hover:text-red-400 rounded-lg hover:bg-gray-800 transition-all duration-200" title="Hapus Chat">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        </header>

        <div id="chatContainer" class="flex-1 overflow-y-auto p-3 md:p-6 custom-scrollbar">
            <% if (!chatHistory || chatHistory.length === 0) { %>
                <div id="welcomeScreen" class="h-full flex flex-col items-center justify-center text-center p-4 md:p-6">
                    <div class="w-24 h-24 md:w-32 md:h-32 bg-gradient-to-br from-blue-600/20 to-purple-600/20 rounded-3xl flex items-center justify-center mb-6 md:mb-8 border border-white/10 shadow-2xl animate-pulse">
                        <i class="fas fa-robot text-5xl md:text-6xl text-blue-400"></i>
                    </div>
                    <h2 class="text-2xl md:text-3xl font-bold text-white mb-3 md:mb-4">Halo, <%= user.username %>! ðŸ‘‹</h2>
                    <p class="text-gray-400 max-w-md text-sm md:text-base leading-relaxed mb-8">
                        Saya Dardcor AI, asisten cerdas Anda. Saya siap membantu tugas kuliah, coding, atau sekedar diskusi ringan.
                    </p>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 max-w-2xl w-full">
                        <button onclick="fillInput('Buatkan kode HTML sederhana')" class="p-4 bg-gray-800/50 rounded-xl border border-gray-700 hover:bg-gray-700 transition-colors text-left">
                            <i class="fas fa-code text-blue-400 text-xl mb-2 block"></i>
                            <span class="text-sm font-medium text-white block">Contoh Coding</span>
                            <span class="text-xs text-gray-400 block mt-1">HTML/CSS/JS Dasar</span>
                        </button>
                        <button onclick="fillInput('Jelaskan tentang Machine Learning')" class="p-4 bg-gray-800/50 rounded-xl border border-gray-700 hover:bg-gray-700 transition-colors text-left">
                            <i class="fas fa-brain text-purple-400 text-xl mb-2 block"></i>
                            <span class="text-sm font-medium text-white block">Penjelasan Konsep</span>
                            <span class="text-xs text-gray-400 block mt-1">Machine Learning</span>
                        </button>
                        <button onclick="fillInput('Ide proyek web untuk pemula')" class="p-4 bg-gray-800/50 rounded-xl border border-gray-700 hover:bg-gray-700 transition-colors text-left">
                            <i class="fas fa-lightbulb text-yellow-400 text-xl mb-2 block"></i>
                            <span class="text-sm font-medium text-white block">Ide Proyek</span>
                            <span class="text-xs text-gray-400 block mt-1">Inspirasi Web App</span>
                        </button>
                    </div>
                </div>
            <% } else { %>
                <% chatHistory.forEach((msg) => { 
                    const role = msg.role === 'user' ? 'user' : 'bot';
                    let content = (msg.parts && msg.parts[0]?.text) ? msg.parts[0].text : (msg.message || '');
                    const file = msg.file_metadata;
                    if(role === 'user' && !content && file) content = "Mengirim file untuk dianalisis.";
                %>
                    <div class="flex w-full <%= role === 'user' ? 'justify-end' : 'justify-start' %> mb-4 md:mb-6 group">
                        <div class="flex flex-col max-w-[90%] md:max-w-[80%] lg:max-w-[70%] gap-1">
                            <div class="flex items-end gap-2 <%= role === 'user' ? 'flex-row-reverse' : 'flex-row' %>">
                                <div class="avatar w-8 h-8 rounded-full flex-shrink-0 overflow-hidden border border-white/10 <%= role === 'user' ? 'bg-blue-600' : 'bg-indigo-600' %>">
                                    <% if(role === 'user') { %>
                                        <img src="<%= user.profile_image || 'https://ui-avatars.com/api/?name=' + user.username + '&background=random' %>" class="w-full h-full object-cover">
                                    <% } else { %>
                                        <div class="w-full h-full flex items-center justify-center"><i class="fas fa-robot text-white text-xs"></i></div>
                                    <% } %>
                                </div>
                                
                                <div class="p-3 md:p-4 <%= role === 'user' ? 'message-user' : 'message-bot' %> shadow-md">
                                    <div class="markdown-body text-sm md:text-base break-words"><%- role === 'bot' ? content : escapeHtml(content) %></div>
                                    <% if(file) { %>
                                        <div class="mt-2 flex items-center gap-2 p-2 bg-black/20 rounded-lg border border-white/5 text-xs">
                                            <i class="fas fa-file text-blue-300"></i>
                                            <span class="truncate max-w-[150px]"><%= file.name %></span>
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                            <div class="text-[10px] text-gray-500 px-1 <%= role === 'user' ? 'text-right' : 'text-left' %> opacity-0 group-hover:opacity-100 transition-opacity">
                                <%= new Date(msg.timestamp || Date.now()).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) %>
                            </div>
                        </div>
                    </div>
                <% }); %>
            <% } %>

            <div id="loadingIndicator" class="hidden w-full mb-6">
                <div class="flex gap-2 items-start max-w-[75%]">
                    <div class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-robot text-white text-xs"></i>
                    </div>
                    <div class="bg-[#1e293b] p-4 rounded-2xl rounded-tl-sm border border-gray-700/50">
                        <div class="typing-indicator flex gap-1"><span></span><span></span><span></span></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-3 md:p-4 bg-[#1a1a2e] border-t border-gray-800">
            <div class="max-w-4xl mx-auto w-full relative">
                <div id="filePreview" class="hidden absolute bottom-full left-0 mb-2 p-3 bg-[#1e293b] border border-gray-700 rounded-xl flex items-center gap-3 shadow-2xl z-50 w-full md:w-auto animate-fade-in">
                    <div class="w-10 h-10 bg-gray-800 rounded-lg flex items-center justify-center overflow-hidden border border-gray-600">
                        <img id="previewImg" class="w-full h-full object-cover hidden">
                        <i id="previewIcon" class="fas fa-file text-blue-400"></i>
                    </div>
                    <div class="flex flex-col flex-1 min-w-0">
                        <span class="text-[10px] text-gray-400 uppercase font-bold">Lampiran</span>
                        <span id="previewName" class="text-sm text-white truncate font-medium"></span>
                    </div>
                    <button onclick="clearFile()" class="p-1 text-gray-400 hover:text-red-400 transition-colors"><i class="fas fa-times"></i></button>
                </div>

                <div class="chat-input flex items-end p-1 md:p-2 gap-2 bg-[#1e293b] border border-[#334155] rounded-2xl shadow-lg focus-within:ring-2 focus-within:ring-blue-500/50 transition-shadow">
                    <button onclick="document.getElementById('fileInput').click()" class="p-2 md:p-3 text-gray-400 hover:text-blue-400 hover:bg-gray-800 rounded-xl transition-all" title="Upload File">
                        <i class="fas fa-paperclip text-lg"></i>
                    </button>
                    
                    <textarea id="chatInput" rows="1" class="flex-1 bg-transparent text-white border-none focus:ring-0 p-2 md:p-3 max-h-32 resize-none text-sm md:text-base placeholder-gray-500 focus:outline-none" placeholder="Tulis pesan..." onkeydown="handleKeydown(event)"></textarea>
                    
                    <button id="sendBtn" onclick="sendMessage()" class="p-2 md:p-3 bg-blue-600 text-white rounded-xl hover:bg-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg shadow-blue-600/20">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <p class="text-center text-[10px] text-gray-600 mt-2">AI dapat membuat kesalahan. Cek info penting.</p>
            </div>
        </div>
    </main>

    <input type="file" id="fileInput" class="hidden" onchange="handleFileSelect(event)">

    <script>
        // === VARS & DOM ELEMENTS ===
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatContainer = document.getElementById('chatContainer');
        const fileInput = document.getElementById('fileInput');
        const mainContent = document.getElementById('mainContent');
        let attachedFile = null;
        let isProcessing = false;
        let isSidebarOpen = false;

        // === SIDEBAR LOGIC (FIXED FOR DESKTOP/MOBILE) ===
        function toggleSidebar() {
            if (window.innerWidth >= 1024) {
                // Desktop Mode: Toggle margin main content & translate sidebar
                isSidebarOpen = !isSidebarOpen;
                if (isSidebarOpen) {
                    // Close Sidebar Desktop
                    sidebar.classList.add('-translate-x-full'); 
                    mainContent.style.marginLeft = "0"; // Expand content
                    sidebar.style.width = "0"; // Hide width to remove blank space
                    sidebar.style.overflow = "hidden";
                } else {
                    // Open Sidebar Desktop
                    sidebar.classList.remove('-translate-x-full');
                    sidebar.style.width = ""; // Reset width to class default
                    sidebar.style.overflow = "";
                }
            } else {
                // Mobile Mode: Use Overlay
                sidebar.classList.toggle('-translate-x-full');
                const isClosed = sidebar.classList.contains('-translate-x-full');
                
                if (!isClosed) {
                    overlay.classList.remove('hidden');
                } else {
                    overlay.classList.add('hidden');
                }
            }
        }
        
        // Close sidebar when clicking overlay (Mobile only)
        overlay.addEventListener('click', () => {
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
        });

        // Handle Resize Reset
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 1024) {
                overlay.classList.add('hidden');
                sidebar.classList.remove('-translate-x-full');
                sidebar.style.width = "";
            } else {
                sidebar.classList.add('-translate-x-full');
            }
        });

        // === FULLSCREEN LOGIC ===
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(e => console.log(e));
                document.getElementById('fullscreenIcon').classList.replace('fa-expand', 'fa-compress');
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                    document.getElementById('fullscreenIcon').classList.replace('fa-compress', 'fa-expand');
                }
            }
        }

        // === MARKDOWN CONFIG ===
        const highlight = hljs;
        marked.setOptions({
            highlight: (code, lang) => {
                const language = highlight.getLanguage(lang) ? lang : 'plaintext';
                return highlight.highlight(code, { language }).value;
            },
            langPrefix: 'hljs language-',
            breaks: true,
            gfm: true
        });

        // === CHAT FUNCTIONS ===
        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Auto resize textarea
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            if(this.value === '') this.style.height = 'auto';
        });

        function handleKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!isProcessing) sendMessage();
            }
        }

        function fillInput(text) {
            chatInput.value = text;
            chatInput.focus();
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        // === FILE HANDLING ===
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                attachedFile = file;
                document.getElementById('filePreview').classList.remove('hidden');
                document.getElementById('previewName').textContent = file.name;
                
                const img = document.getElementById('previewImg');
                const icon = document.getElementById('previewIcon');
                
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        img.src = e.target.result;
                        img.classList.remove('hidden');
                        icon.classList.add('hidden');
                    };
                    reader.readAsDataURL(file);
                } else {
                    img.classList.add('hidden');
                    icon.classList.remove('hidden');
                }
            }
        }

        function clearFile() {
            attachedFile = null;
            fileInput.value = '';
            document.getElementById('filePreview').classList.add('hidden');
        }

        // === SEND MESSAGE ===
        async function sendMessage() {
            const text = chatInput.value.trim();
            if ((!text && !attachedFile) || isProcessing) return;

            isProcessing = true;
            sendBtn.disabled = true;
            
            // Hapus Welcome Screen jika ada
            const welcome = document.getElementById('welcomeScreen');
            if (welcome) welcome.remove();

            // Tampilkan Chat User
            const userHtml = `
                <div class="flex w-full justify-end mb-4 md:mb-6 group animate-fade-in">
                    <div class="flex flex-col max-w-[90%] md:max-w-[80%] gap-1">
                        <div class="flex items-end gap-2 flex-row-reverse">
                            <div class="avatar w-8 h-8 rounded-full bg-blue-600 overflow-hidden border border-white/10">
                                <img src="<%= user.profile_image || 'https://ui-avatars.com/api/?name=' + user.username %>" class="w-full h-full object-cover">
                            </div>
                            <div class="p-3 md:p-4 message-user shadow-md">
                                <div class="whitespace-pre-wrap text-sm md:text-base">${escapeHtml(text)}</div>
                                ${attachedFile ? `<div class="mt-2 text-xs bg-black/20 p-2 rounded flex items-center gap-2"><i class="fas fa-file"></i> ${attachedFile.name}</div>` : ''}
                            </div>
                        </div>
                    </div>
                </div>`;
            
            chatContainer.insertAdjacentHTML('beforeend', userHtml);
            scrollToBottom();

            // Tampilkan Loading
            document.getElementById('loadingIndicator').classList.remove('hidden');
            scrollToBottom();

            // Kirim ke Server
            const formData = new FormData();
            formData.append('message', text);
            if (attachedFile) formData.append('file_attachment', attachedFile);

            // Reset Input
            chatInput.value = '';
            chatInput.style.height = 'auto';
            clearFile();

            try {
                const res = await fetch('/user/ai/chat', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                document.getElementById('loadingIndicator').classList.add('hidden');

                if (data.success) {
                    const botHtml = `
                        <div class="flex w-full justify-start mb-4 md:mb-6 group animate-fade-in">
                            <div class="flex flex-col max-w-[90%] md:max-w-[80%] gap-1">
                                <div class="flex items-end gap-2">
                                    <div class="avatar w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center border border-white/10">
                                        <i class="fas fa-robot text-white text-xs"></i>
                                    </div>
                                    <div class="p-3 md:p-4 message-bot shadow-md">
                                        <div class="markdown-body text-sm md:text-base">${marked.parse(data.response)}</div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    
                    chatContainer.insertAdjacentHTML('beforeend', botHtml);
                    
                    // Highlight Code
                    document.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });
                    
                    // Jika chat baru, reload URL agar history tersimpan di sidebar
                    if (data.isNewConversation) {
                        window.history.pushState({}, '', `/user/dardcor-ai/${data.conversationId}`);
                        // Optional: Refresh sidebar list via AJAX instead of full reload for better UX
                    }

                } else {
                    alert('Error: ' + data.response);
                }
            } catch (e) {
                document.getElementById('loadingIndicator').classList.add('hidden');
                alert('Gagal terhubung ke server.');
            }

            isProcessing = false;
            sendBtn.disabled = false;
            scrollToBottom();
        }

        function clearChat() {
            if (confirm('Hapus percakapan ini?')) {
                fetch('/user/ai/clear-chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ conversationId: '<%= activeConversationId %>' })
                }).then(() => window.location.href = '/user/dardcor-ai');
            }
        }

        // Initial Scroll
        scrollToBottom();

        // Init New Chat Button
        document.getElementById('newChatBtn').addEventListener('click', async () => {
             try {
                const res = await fetch('/user/ai/new-chat', { method: 'POST' });
                const data = await res.json();
                if (data.success) window.location.href = data.redirectUrl;
            } catch (e) { console.error(e); }
        });
    </script>
</body>
</html>