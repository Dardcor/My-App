<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a1a2e">
    <title>Dardcor AI</title>
    
    <link rel="icon" href="/logo.png">
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        * { 
            box-sizing: border-box; 
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #1a1a2e;
            color: #cbd5e1;
            overflow-x: hidden;
            height: 100vh;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #0f172a;
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        /* Sidebar Styling */
        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 280px;
            background: #16213e;
            border-right: 1px solid #334155;
            z-index: 1000;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.3);
        }

        #sidebar.open {
            transform: translateX(0);
        }

        /* Overlay for mobile */
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
            backdrop-filter: blur(2px);
        }

        #overlay.active {
            display: block;
        }

        /* Message Bubbles */
        .message-user {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border-radius: 18px 18px 4px 18px;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        }
        
        .message-bot {
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 18px 18px 18px 4px;
            border: 1px solid #334155;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* Code Block Styling */
        .code-block-wrapper {
            margin: 12px 0;
            border-radius: 8px;
            overflow: hidden;
            background: #0d1117;
            border: 1px solid #30363d;
        }
        
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #161b22;
            padding: 8px 12px;
            border-bottom: 1px solid #30363d;
            font-size: 0.75rem;
            color: #7d8590;
        }
        
        .terminal-dots { 
            display: flex; 
            gap: 6px; 
        }
        
        .dot { 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
        }
        
        .dot-red { background: #ff5f56; }
        .dot-yellow { background: #ffbd2e; }
        .dot-green { background: #27c93f; }
        
        pre { 
            margin: 0 !important; 
            padding: 0 !important; 
            background: transparent !important; 
        }
        
        code.hljs {
            padding: 16px !important;
            font-family: 'Fira Code', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            background: #0d1117 !important;
        }
        
        .copy-btn {
            background: transparent;
            border: none;
            color: #7d8590;
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: color 0.2s;
        }
        
        .copy-btn:hover { 
            color: #fff; 
        }

        /* Chat Input */
        .chat-input {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 1.5rem;
            transition: all 0.2s;
        }
        
        .chat-input:focus-within { 
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        /* Typing Indicator Animation */
        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: #94a3b8;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
            margin: 0 1px;
        }
        
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .message-user, 
            .message-bot {
                border-radius: 16px;
                padding: 10px 14px !important;
            }
            
            .code-header {
                flex-wrap: wrap;
                padding: 6px 8px;
            }
            
            .chat-input {
                border-radius: 1rem;
                padding: 4px !important;
            }
            
            #sidebar {
                width: 85%;
                max-width: 300px;
            }
        }

        @media (min-width: 1024px) {
            #sidebar {
                transform: translateX(0) !important;
                position: relative !important;
                height: 100vh;
            }
            
            #overlay {
                display: none !important;
            }
            
            main {
                margin-left: 0 !important;
                width: calc(100% - 280px);
            }
        }

        /* Smooth transitions */
        .transition-all {
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }

        /* Markdown content styling */
        .markdown-body {
            line-height: 1.6;
        }
        
        .markdown-body p {
            margin-bottom: 0.75rem;
        }
        
        .markdown-body ul, 
        .markdown-body ol {
            padding-left: 1.5rem;
            margin-bottom: 0.75rem;
        }
        
        .markdown-body li {
            margin-bottom: 0.25rem;
        }
        
        .markdown-body h1, 
        .markdown-body h2, 
        .markdown-body h3 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        /* Avatar styling */
        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        @media (max-width: 640px) {
            .avatar {
                width: 28px;
                height: 28px;
            }
        }
    </style>
</head>

<body class="flex h-screen overflow-hidden">
    <!-- Mobile Overlay -->
    <div id="overlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="flex flex-col h-full">
        <!-- Sidebar Header -->
        <div class="p-4 flex items-center justify-between border-b border-gray-800 bg-[#131b2e]">
            <a href="/user/home" class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-purple-600 rounded-xl flex items-center justify-center text-white shadow-lg">
                    <i class="fas fa-robot text-lg"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-white">Dardcor AI</h1>
                    <p class="text-xs text-gray-400">Asisten Cerdas</p>
                </div>
            </a>
            <button onclick="closeSidebar()" class="lg:hidden text-gray-400 hover:text-white p-2 rounded-lg hover:bg-gray-800">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <!-- New Chat Button -->
        <div class="p-4">
            <button id="newChatBtn" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white py-3 px-4 rounded-xl flex items-center justify-center gap-2 shadow-lg shadow-blue-900/30 font-medium transition-all duration-200 active:scale-95">
                <i class="fas fa-plus"></i>
                <span>Chat Baru</span>
            </button>
        </div>

        <!-- Chat History List -->
        <div class="flex-1 overflow-y-auto px-3 custom-scrollbar">
            <div class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider sticky top-0 bg-[#16213e] z-10">
                <div class="flex items-center justify-between">
                    <span>Riwayat</span>
                    <span class="text-xs bg-gray-800 px-2 py-1 rounded-full">
                        <% if (typeof fullHistory !== 'undefined') { %>
                            <%= fullHistory.length %>
                        <% } else { %>
                            0
                        <% } %>
                    </span>
                </div>
            </div>
            
            <div class="space-y-1 pb-4">
                <% if (typeof fullHistory !== 'undefined' && fullHistory.length > 0) { 
                    const reversedHistory = fullHistory.slice().reverse();
                    for(let i = 0; i < reversedHistory.length; i++) {
                        const conv = reversedHistory[i];
                        const isActive = conv.conversation_id === activeConversationId;
                        const title = (conv.message || 'Percakapan Baru').substring(0, 30) + (conv.message?.length > 30 ? '...' : '');
                %>
                    <a href="/user/dardcor-ai/<%= conv.conversation_id %>" 
                       class="flex items-center gap-3 px-3 py-3 rounded-lg text-sm transition-all duration-200 <%= isActive ? 'bg-gradient-to-r from-blue-900/30 to-blue-800/20 text-white border-l-4 border-blue-500' : 'text-gray-400 hover:bg-gray-800/50 hover:text-gray-200' %>">
                        <i class="fas fa-comment text-xs <%= isActive ? 'text-blue-400' : 'text-gray-600' %>"></i>
                        <span class="truncate flex-1"><%= title %></span>
                        <span class="text-xs text-gray-600"><%= new Date(conv.timestamp || Date.now()).toLocaleDateString('id-ID', {month: 'short', day: 'numeric'}) %></span>
                    </a>
                <% }} else { %>
                    <div class="text-center py-10 px-4 opacity-50">
                        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gray-800 flex items-center justify-center">
                            <i class="fas fa-comment-slash text-2xl text-gray-600"></i>
                        </div>
                        <p class="text-gray-600 text-sm">Belum ada percakapan</p>
                        <p class="text-gray-700 text-xs mt-1">Mulai percakapan baru dengan AI</p>
                    </div>
                <% } %>
            </div>
        </div>

        <!-- User Profile -->
        <div class="p-4 border-t border-gray-800 bg-[#131b2e]">
            <a href="/user/profile" class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-800 transition-all duration-200">
                <div class="relative">
                    <img src="<%= user.profile_image || 'https://ui-avatars.com/api/?name=' + (user.username || 'User') + '&background=random&color=fff' %>" 
                         class="w-10 h-10 rounded-full object-cover border-2 border-gray-700">
                    <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-[#131b2e]"></div>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-white truncate"><%= user.full_name || user.username %></p>
                    <p class="text-xs text-gray-500 truncate">@<%= user.username %></p>
                </div>
                <i class="fas fa-chevron-right text-gray-500 text-sm"></i>
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full min-w-0 bg-[#1a1a2e] transition-all duration-300" id="mainContent">
        <!-- Header -->
        <header class="h-16 flex items-center justify-between px-4 md:px-6 border-b border-gray-800 bg-[#1a1a2e] sticky top-0 z-50 shadow-sm">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" 
                        class="p-2 rounded-lg text-gray-400 hover:text-white hover:bg-gray-800 transition-all duration-200 lg:hidden">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600/20 to-purple-600/20 flex items-center justify-center border border-white/5">
                        <i class="fas fa-robot text-blue-400"></i>
                    </div>
                    <div>
                        <h2 class="font-semibold text-white text-sm md:text-base">Asisten Dardcor AI</h2>
                        <p class="text-xs text-green-400 flex items-center gap-1">
                            <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span> 
                            Online
                        </p>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="document.documentElement.requestFullscreen()" 
                        class="p-2 text-gray-400 hover:text-white rounded-lg hover:bg-gray-800 transition-all duration-200 hidden sm:block">
                    <i class="fas fa-expand"></i>
                </button>
                <button onclick="clearChat()" 
                        class="p-2 text-gray-400 hover:text-white rounded-lg hover:bg-gray-800 transition-all duration-200">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        </header>

        <!-- Chat Container -->
        <div id="chatContainer" class="flex-1 overflow-y-auto p-3 md:p-6 custom-scrollbar">
            <% if (!chatHistory || chatHistory.length === 0) { %>
                <!-- Welcome Screen -->
                <div id="welcomeScreen" class="h-full flex flex-col items-center justify-center text-center p-4 md:p-6">
                    <div class="w-24 h-24 md:w-32 md:h-32 bg-gradient-to-br from-blue-600/20 to-purple-600/20 rounded-3xl flex items-center justify-center mb-6 md:mb-8 border border-white/10 shadow-2xl">
                        <i class="fas fa-robot text-5xl md:text-6xl text-blue-400"></i>
                    </div>
                    <h2 class="text-2xl md:text-3xl font-bold text-white mb-3 md:mb-4">Halo, <%= user.username %>! ðŸ‘‹</h2>
                    <p class="text-gray-400 max-w-md text-sm md:text-base leading-relaxed mb-8">
                        Saya Dardcor AI, asisten cerdas Anda. Saya bisa membantu dengan coding, analisis tugas, 
                        menjawab pertanyaan kompleks, dan banyak lagi.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 max-w-2xl w-full">
                        <div class="p-4 bg-gray-800/50 rounded-xl border border-gray-700">
                            <i class="fas fa-code text-blue-400 text-xl mb-2"></i>
                            <p class="text-xs text-gray-300">Bantuan Coding</p>
                        </div>
                        <div class="p-4 bg-gray-800/50 rounded-xl border border-gray-700">
                            <i class="fas fa-file-alt text-green-400 text-xl mb-2"></i>
                            <p class="text-xs text-gray-300">Analisis Dokumen</p>
                        </div>
                        <div class="p-4 bg-gray-800/50 rounded-xl border border-gray-700">
                            <i class="fas fa-lightbulb text-yellow-400 text-xl mb-2"></i>
                            <p class="text-xs text-gray-300">Ide Kreatif</p>
                        </div>
                    </div>
                </div>
            <% } else { %>
                <!-- Chat History Rendering -->
                <% chatHistory.forEach((msg, index) => { 
                    const role = msg.role === 'user' ? 'user' : 'bot';
                    let content = (msg.parts && msg.parts[0]?.text) ? msg.parts[0].text : (msg.message || '');
                    const file = msg.file_metadata;
                    if(role === 'user' && !content && file) content = "Mengirim file untuk dianalisis.";
                %>
                    <div class="flex w-full <%= role === 'user' ? 'justify-end' : 'justify-start' %> mb-4 md:mb-6">
                        <div class="flex flex-col max-w-[90%] md:max-w-[75%] lg:max-w-[65%] gap-1">
                            <div class="flex items-end gap-2 <%= role === 'user' ? 'flex-row-reverse' : 'flex-row' %>">
                                <!-- Avatar -->
                                <div class="avatar <%= role === 'user' ? 'bg-gradient-to-br from-blue-600 to-blue-800' : 'bg-gradient-to-br from-indigo-600 to-purple-600' %>">
                                    <% if(role === 'user') { %>
                                        <img src="<%= user.profile_image || 'https://ui-avatars.com/api/?name=' + user.username + '&background=random' %>" 
                                             class="w-full h-full object-cover rounded-full">
                                    <% } else { %>
                                        <div class="w-full h-full flex items-center justify-center">
                                            <i class="fas fa-robot text-white text-sm"></i>
                                        </div>
                                    <% } %>
                                </div>
                                
                                <!-- Message Bubble -->
                                <div class="p-3 md:p-4 <%= role === 'user' ? 'message-user' : 'message-bot' %>">
                                    <% if(role === 'bot') { %>
                                        <div class="markdown-body space-y-2 text-sm md:text-base"><%- content %></div>
                                    <% } else { %>
                                        <div class="whitespace-pre-wrap text-sm md:text-base"><%= content %></div>
                                        <% if(file) { %>
                                            <div class="mt-2 flex items-center gap-2 p-2 bg-white/10 rounded-lg border border-white/10 text-xs">
                                                <div class="w-6 h-6 md:w-8 md:h-8 bg-white/20 rounded-lg flex items-center justify-center">
                                                    <i class="fas <%= file.type?.startsWith('image') ? 'fa-image' : 'fa-file' %> text-xs"></i>
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <p class="text-white font-medium truncate"><%= file.name %></p>
                                                    <p class="text-gray-400 text-xs"><%= (file.size / 1024).toFixed(1) %> KB</p>
                                                </div>
                                            </div>
                                        <% } %>
                                    <% } %>
                                </div>
                            </div>
                            <div class="text-xs text-gray-500 px-1 <%= role === 'user' ? 'text-right' : 'text-left' %>">
                                <%= new Date(msg.timestamp || Date.now()).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) %>
                            </div>
                        </div>
                    </div>
                <% }); %>
            <% } %>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="hidden w-full mb-6">
                <div class="flex gap-2 items-start max-w-[75%]">
                    <div class="avatar bg-gradient-to-br from-indigo-600 to-purple-600">
                        <div class="w-full h-full flex items-center justify-center">
                            <i class="fas fa-robot text-white text-sm"></i>
                        </div>
                    </div>
                    <div class="bg-[#1e293b] p-4 rounded-2xl rounded-tl-sm border border-gray-700/50">
                        <div class="typing-indicator flex gap-1">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <p class="text-xs text-gray-400 mt-2">AI sedang mengetik...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-3 md:p-4 bg-[#1a1a2e] border-t border-gray-800">
            <div class="max-w-6xl mx-auto w-full relative">
                <!-- File Preview Popup -->
                <div id="filePreview" class="hidden absolute bottom-full left-0 mb-2 p-3 bg-[#1e293b] border border-gray-700 rounded-xl flex items-center gap-3 shadow-2xl z-50">
                    <div class="w-10 h-10 bg-gray-800 rounded-lg flex items-center justify-center overflow-hidden border border-gray-600">
                        <img id="previewImg" class="w-full h-full object-cover hidden">
                        <i id="previewIcon" class="fas fa-file text-blue-400"></i>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-[10px] text-gray-400 uppercase font-bold">File Terlampir</span>
                        <div class="flex items-center gap-2">
                            <span id="previewName" class="text-sm text-white max-w-[120px] md:max-w-[180px] truncate font-medium"></span>
                            <span id="previewSize" class="text-xs text-gray-400"></span>
                        </div>
                    </div>
                    <button onclick="clearFile()" 
                            class="w-6 h-6 rounded-full bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white flex items-center justify-center transition-all duration-200 ml-2">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>

                <!-- Input Field -->
                <div class="chat-input flex items-end p-1 md:p-2 gap-2">
                    <button onclick="document.getElementById('fileInput').click()" 
                            class="p-2 md:p-3 text-gray-400 hover:text-blue-400 flex-shrink-0 hover:bg-gray-800 rounded-xl transition-all duration-200">
                        <i class="fas fa-paperclip text-lg"></i>
                    </button>
                    
                    <textarea id="chatInput" 
                              rows="1" 
                              class="flex-1 bg-transparent text-white border-none focus:ring-0 p-2 md:p-3 max-h-32 resize-none text-sm md:text-base placeholder-gray-500 focus:outline-none"
                              placeholder="Tanyakan sesuatu pada AI... (Shift+Enter untuk baris baru)"
                              onkeydown="handleKeydown(event)"></textarea>
                    
                    <button id="sendBtn" 
                            class="p-2 md:p-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl hover:from-blue-500 hover:to-blue-600 disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0 shadow-lg shadow-blue-900/20 transition-all duration-200 active:scale-95"
                            onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <p class="text-center text-xs text-gray-500 mt-2 px-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    Dardcor AI dapat membuat kesalahan. Harap periksa kembali informasi penting.
                </p>
            </div>
        </div>
    </main>

    <input type="file" id="fileInput" class="hidden" accept=".txt,.pdf,.jpg,.jpeg,.png,.doc,.docx">

    <script>
        // Global variables
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatContainer = document.getElementById('chatContainer');
        const fileInput = document.getElementById('fileInput');
        const mainContent = document.getElementById('mainContent');
        
        let attachedFile = null;
        let isProcessing = false;

        // Initialize Markdown renderer
        const highlight = hljs;
        
        marked.setOptions({
            highlight: function(code, lang) {
                const language = highlight.getLanguage(lang) ? lang : 'plaintext';
                return highlight.highlight(code, { language }).value;
            },
            langPrefix: 'hljs language-',
            breaks: true,
            gfm: true
        });

        const renderer = new marked.Renderer();
        renderer.code = function(code, language, escaped) {
            const validLang = !!(language && highlight.getLanguage(language));
            const highlighted = validLang 
                ? highlight.highlight(code, { language }).value 
                : highlight.highlightAuto(code).value;
            const langLabel = validLang ? language : 'Text';
            
            return `
                <div class="code-block-wrapper">
                    <div class="code-header">
                        <div class="flex items-center gap-2">
                            <div class="terminal-dots">
                                <div class="dot dot-red"></div>
                                <div class="dot dot-yellow"></div>
                                <div class="dot dot-green"></div>
                            </div>
                            <span class="uppercase font-mono text-[10px] font-bold">${langLabel}</span>
                        </div>
                        <button class="copy-btn" onclick="copyToClipboard(this)">
                            <i class="far fa-copy"></i> Copy
                        </button>
                    </div>
                    <pre><code class="hljs ${language || ''}">${highlighted}</code></pre>
                </div>`;
        };
        
        marked.use({ renderer });

        // Sidebar functions
        function toggleSidebar() {
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
            
            if (sidebar.classList.contains('open')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }

        function openSidebar() {
            sidebar.classList.add('open');
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeSidebar() {
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Auto-resize textarea
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 128) + 'px';
            updateSendButton();
        });

        function updateSendButton() {
            sendBtn.disabled = chatInput.value.trim() === '' && !attachedFile;
        }

        // Keyboard handling
        function handleKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!sendBtn.disabled && !isProcessing) {
                    sendMessage();
                }
            }
        }

        // File handling
        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) {
                attachedFile = e.target.files[0];
                const preview = document.getElementById('filePreview');
                preview.classList.remove('hidden');
                
                document.getElementById('previewName').textContent = attachedFile.name;
                document.getElementById('previewSize').textContent = formatFileSize(attachedFile.size);
                
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = document.getElementById('previewImg');
                    const icon = document.getElementById('previewIcon');
                    
                    if (attachedFile.type.startsWith('image/')) {
                        img.src = ev.target.result;
                        img.classList.remove('hidden');
                        icon.classList.add('hidden');
                    } else {
                        img.classList.add('hidden');
                        icon.classList.remove('hidden');
                        icon.className = getFileIcon(attachedFile.type);
                    }
                };
                reader.readAsDataURL(attachedFile);
                updateSendButton();
            }
        });

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function getFileIcon(mimeType) {
            if (mimeType.includes('pdf')) return 'fas fa-file-pdf text-red-400';
            if (mimeType.includes('word') || mimeType.includes('document')) return 'fas fa-file-word text-blue-400';
            if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) return 'fas fa-file-excel text-green-400';
            if (mimeType.includes('image')) return 'fas fa-file-image text-purple-400';
            if (mimeType.includes('text')) return 'fas fa-file-alt text-gray-400';
            return 'fas fa-file text-gray-400';
        }

        function clearFile() {
            attachedFile = null;
            fileInput.value = '';
            document.getElementById('filePreview').classList.add('hidden');
            updateSendButton();
        }

        // Send message function
        async function sendMessage() {
            const text = chatInput.value.trim();
            if ((!text && !attachedFile) || isProcessing) return;

            isProcessing = true;
            sendBtn.disabled = true;
            chatInput.disabled = true;
            
            // Remove welcome screen if exists
            const welcomeScreen = document.getElementById('welcomeScreen');
            if (welcomeScreen) {
                welcomeScreen.style.opacity = '0';
                welcomeScreen.style.transform = 'translateY(20px)';
                setTimeout(() => welcomeScreen.remove(), 300);
            }

            // Render user message
            const userDiv = document.createElement('div');
            userDiv.className = 'flex w-full justify-end mb-4 md:mb-6 animate-slide-in';
            userDiv.innerHTML = `
                <div class="flex flex-col max-w-[90%] md:max-w-[75%] lg:max-w-[65%] gap-1">
                    <div class="flex items-end gap-2 flex-row-reverse">
                        <div class="avatar bg-gradient-to-br from-blue-600 to-blue-800">
                            <img src="<%= user.profile_image || 'https://ui-avatars.com/api/?name=' + user.username + '&background=random' %>" 
                                 class="w-full h-full object-cover rounded-full">
                        </div>
                        <div class="p-3 md:p-4 message-user">
                            <div class="whitespace-pre-wrap text-sm md:text-base">${escapeHtml(text)}</div>
                            ${attachedFile ? `
                                <div class="mt-2 flex items-center gap-2 p-2 bg-white/10 rounded-lg border border-white/10 text-xs">
                                    <div class="w-6 h-6 md:w-8 md:h-8 bg-white/20 rounded-lg flex items-center justify-center">
                                        <i class="${getFileIcon(attachedFile.type)}"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-white font-medium truncate">${attachedFile.name}</p>
                                        <p class="text-gray-400 text-xs">${formatFileSize(attachedFile.size)}</p>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 px-1 text-right">
                        ${new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}
                    </div>
                </div>`;
            
            chatContainer.appendChild(userDiv);
            scrollToBottom();

            // Show loading indicator
            const loading = document.getElementById('loadingIndicator');
            loading.classList.remove('hidden');
            scrollToBottom();

            // Prepare form data
            const formData = new FormData();
            formData.append('message', text);
            if (attachedFile) formData.append('file_attachment', attachedFile);

            // Reset input
            chatInput.value = '';
            chatInput.style.height = 'auto';
            clearFile();

            try {
                const res = await fetch('/user/ai/chat', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await res.json();
                loading.classList.add('hidden');

                if (data.success) {
                    const botDiv = document.createElement('div');
                    botDiv.className = 'flex w-full justify-start mb-4 md:mb-6 animate-slide-in';
                    const parsedMarkdown = marked.parse(data.response);
                    
                    botDiv.innerHTML = `
                        <div class="flex flex-col max-w-[90%] md:max-w-[75%] lg:max-w-[65%] gap-1">
                            <div class="flex items-end gap-2 flex-row">
                                <div class="avatar bg-gradient-to-br from-indigo-600 to-purple-600">
                                    <div class="w-full h-full flex items-center justify-center">
                                        <i class="fas fa-robot text-white text-sm"></i>
                                    </div>
                                </div>
                                <div class="p-3 md:p-4 message-bot">
                                    <div class="markdown-body text-sm md:text-base">${parsedMarkdown}</div>
                                </div>
                            </div>
                            <div class="text-xs text-gray-500 px-1 text-left">
                                ${new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}
                            </div>
                        </div>`;
                    
                    chatContainer.appendChild(botDiv);
                    
                    // Update code highlighting for new content
                    setTimeout(() => {
                        document.querySelectorAll('pre code').forEach((block) => {
                            highlight.highlightElement(block);
                        });
                    }, 100);
                    
                    if (data.isNewConversation) {
                        window.history.pushState({}, '', `/user/dardcor-ai/${data.conversationId}`);
                        setTimeout(() => location.reload(), 1000);
                    }
                } else {
                    showError('Error: ' + data.response);
                }
            } catch (err) {
                loading.classList.add('hidden');
                showError('Gagal terhubung ke server. Periksa koneksi internet Anda.');
            }

            isProcessing = false;
            chatInput.disabled = false;
            chatInput.focus();
            scrollToBottom();
        }

        // Utility functions
        function scrollToBottom() {
            setTimeout(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 100);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-600 text-white px-4 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
            errorDiv.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>${message}</span>
                </div>`;
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function copyToClipboard(btn) {
            const codeBlock = btn.parentElement.nextElementSibling.querySelector('code');
            navigator.clipboard.writeText(codeBlock.innerText).then(() => {
                const icon = btn.querySelector('i');
                const originalClass = icon.className;
                icon.className = 'fas fa-check';
                btn.classList.add('text-green-400');
                
                setTimeout(() => {
                    icon.className = originalClass;
                    btn.classList.remove('text-green-400');
                }, 2000);
            });
        }

        function clearChat() {
            if (confirm('Apakah Anda yakin ingin menghapus percakapan ini?')) {
                fetch('/user/ai/clear-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ conversationId: '<%= activeConversationId %>' })
                }).then(() => {
                    location.reload();
                });
            }
        }

        // Initialize event listeners
        sendBtn.addEventListener('click', sendMessage);
        document.getElementById('newChatBtn').addEventListener('click', async () => {
            try {
                const res = await fetch('/user/ai/new-chat', { method: 'POST' });
                const data = await res.json();
                if (data.success) window.location.href = data.redirectUrl;
            } catch (e) {
                console.error(e);
                showError('Gagal membuat chat baru');
            }
        });

        // Initialize on load
        window.addEventListener('load', () => {
            // Initialize existing markdown content
            document.querySelectorAll('.markdown-body').forEach(block => {
                block.innerHTML = marked.parse(block.innerHTML);
            });
            
            // Highlight code blocks
            document.querySelectorAll('pre code').forEach((block) => {
                highlight.highlightElement(block);
            });
            
            // Scroll to bottom
            scrollToBottom();
            
            // Close sidebar on mobile when clicking outside
            overlay.addEventListener('click', closeSidebar);
            
            // Handle escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeSidebar();
            });
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 1024) {
                closeSidebar();
            }
        });

        // Add animation styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slide-in {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            @keyframes fade-in {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            .animate-slide-in {
                animation: slide-in 0.3s ease-out;
            }
            
            .animate-fade-in {
                animation: fade-in 0.3s ease-out;
            }
            
            @media (max-width: 768px) {
                #mainContent {
                    margin-left: 0 !important;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>